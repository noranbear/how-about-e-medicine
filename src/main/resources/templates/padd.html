<!DOCTYPE html>
<!--
=========================================================
* Material Dashboard 2 - v3.0.4
=========================================================

* Product Page: https://www.creative-tim.com/product/material-dashboard
* Copyright 2022 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->
<!-- Version: 3.0 -->
<!-- Description: 처방내역 추가 페이지

-------------------------------------------------------------------------
	Date			 Author							Note
-------------------------------------------------------------------------								    
2022. 7. 18			noranbear					First Creation

2022. 7. 22.		najune			 	         profile 화면 구현

2022. 7. 22.		qwaszx357					footer 지우기

2022. 7. 29.		najune						profile 수정 기능 구현

2022. 8. 8.			ynr1734				  페이지 타이틀 변경 및 favicon 변경

2022. 8. 11.		noranbear			  ocr 버튼 및 기능 구현(DB에 넣기)

2022. 8. 12.								ocr 스캔: 화면 출력 기능 구현

                najune						plist 추가 기능 구현

-------------------------------------------------------------------------
-->

<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">

<!-- 1. Bootstrap import 시작 -->
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
<link rel="icon" type="image/png" href="../assets/img/favicon.png">
<!-- 1. 끝 -->

<title>e약어때</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- 2. Bootstrap import 시작 -->
<!-- Fonts and icons  -->
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
<!-- Nucleo Icons -->
<link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
<link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
<!-- Font Awesome Icons -->
<script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<!-- CSS Files -->
<link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.0.4" rel="stylesheet" />
<!-- 2. 끝 -->

<style>
.span{
font-size:1em;
}
.sinup_form.input{
  height : 30px;
  width : 200px;
  border : 1px solid #515151;
  box-sizing : border-box;
  vertical-align: top;
  border-radius: 20px;
  text-indent : 10px;
  outline : none;
}

.sinup_form.input{
  height : 30px;
  width : 50px;
  border-radius: 20px;
  border : 1px solid #515151;
  box-sizing : border-box;
  vertical-align: top;
  outline : none;
}

/* 5. Modal CSS 시작 ---- */
#modal-body{
	text-align:center;
}

.btn-upload {
  width: 150px;
  height: 30px;
  background: #e91e63;
  color:white;
  border-radius: 10px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-upload:hover {
	color:white;
}

#file {
  display: none;
}

#url-search{
	width:400px;
	text-align:center;
}

#preview{
	width:400px;
	height:300px;
}
/* 5. Modal CSS 끝 --- */
</style>

<script>
/**
 * 약이름을 화면 input에 출력하는 함수
 */
function putmedi(mdata){
	var html = "";
	
	$('#medidiv').empty();
	
	// 약이름을 담은 input 생성
	$.each(mdata, function (i, item){
		html += "<div class='input-group input-group-outline mb-3'>";
		html += "<label class='form-label'>medicine</label>";
		html += "<input id='name' name='name' type='text' value='"+ mdata[i].mediname +"' class='form-control'></div>";	
	});
	$('#medidiv').html(html);
	
	console.log("What to print out: " + html);
}

/**
 * ocr 스캔 후 약이름을 가져오는 함수
 */
function getmedi(imgname) {
	console.log("The img to scan: " + imgname);
	
	$.ajax({
		method: 'POST',
		url:'/eocrimpl',
		data:{'imgname':imgname},
		// [1] 해당 데이터가 없을 때
		error: function(error) {
			console.log("eocr doesn't work.");
		},
		// [2] 해당 데이터가 있을 때
		success:function(data){
		 	console.log(data);
		 	// 해당 데이터를 input에 출력하기
			putmedi(data);	
		}
	});
	
}


$(document).ready(function(){
	var start = $('#start').text();			// getmedi 실행 여부
	var imgname = $('#imgname').text();		// eocraddimpl에서 받아온 imgname
	
	/* 추가 버튼 클릭 시, 처방내역 추가 */
	$('#add_btn').click(function(){
		$('#add_form').attr({
			'method':'post',
			'action':'addimpl'
		});
		$('#add_form').submit();
	})
	
	/* ocr 창에서 검색 버튼 클릭 시, 해당 사진 저장 */
	$('#envbt').click(function(){
		
		// envelope 폴더에 ocr 이미지 저장 후 스캔내역 DB에 정보 저장 및 처방정보 가져오기
		$('#ocrenv').attr({
			'enctype':'multipart/form-data',
			'method':'post',
			'action':'eocraddimpl'
		});
		
		$('#ocrenv').submit();
				
	});
	
	// eocraddimpl 실행여부 확인 후, 실행 후이면 getmedi 실행
	if(start == "ok"){
		console.log("Execute getmedi? " + start);
		// ocr 스캔 후 약이름 가져오기
		getmedi(imgname);
	}

});

/*
 * Modal 창에서 input 이미지 프리뷰 
 */
function readURL(input) {
	if (input.files && input.files[0]) {
		var reader = new FileReader();
	    reader.onload = function(e) {
			document.getElementById('preview').src = e.target.result;
	    };
	    reader.readAsDataURL(input.files[0]);
	} else {
	    document.getElementById('preview').src = "";
	}
}
</script>

</head>


<body class="bg-gray-200">
	<div class="container position-sticky z-index-sticky top-0">
		<div class="row">
			<div class="col-12">
			
				<!-- Header Start -->
				<nav class="navbar navbar-expand-lg blur border-radius-xl top-0 z-index-3 shadow position-absolute my-3 py-2 start-0 end-0 mx-4">
					<div class="container-fluid ps-2 pe-0">
						<span class="navbar-brand font-weight-bolder ms-lg-0 ms-3 ">
						e약어때
						</span>
						<button class="navbar-toggler shadow-none ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
							<span class="navbar-toggler-icon mt-2">
								<span class="navbar-toggler-bar bar1"></span>
								<span class="navbar-toggler-bar bar2"></span>
								<span class="navbar-toggler-bar bar3"></span>
							</span>
						</button>
						<div class="collapse navbar-collapse" id="navigation">
							<ul class="navbar-nav mx-auto">
								<li class="nav-item">
									<a class="nav-link d-flex align-items-center me-2 active" aria-current="page" th:href="@{/dashboard}">
										<i class="fa fa-chart-pie opacity-6 text-dark me-1"></i>
										대시보드
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link me-2" th:href="@{/profile}">
										<i class="fa fa-user opacity-6 text-dark me-1"></i>
										마이페이지
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link me-2" th:href="@{/signin}">
										<i class="fas fa-key opacity-6 text-dark me-1"></i>
										로그인
									</a>
								</li>
							</ul>
							<ul class="navbar-nav d-lg-block d-none">
								<li class="nav-item">
									<a th:href="@{/}" class="btn btn-sm mb-0 me-1 bg-gradient-dark">홈으로 이동</a>
								</li>
							</ul>
						</div>
					</div>
				</nav>
				<!-- End Header -->
				
			</div>
		</div>
	</div>
	<!-- Main Start -->
	<main class="main-content  mt-0">
		<div class="page-header align-items-start min-vh-100" style="background-image: url('https://images.unsplash.com/photo-1497294815431-9365093b7331?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1950&q=80');">
			<span class="mask bg-gradient-dark opacity-6"></span>
			<div class="container my-auto">
				<div class="row">
					<div class="col-lg-4 col-md-8 col-12 mx-auto">
						<div class="card z-index-0 fadeIn3 fadeInBottom">
							<div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
								<div class="bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1">
									<h4 class="text-white font-weight-bolder text-center mt-2 mb-0">처방내역 추가</h4>
								</div>
							</div>
							<!-- 처방내역 추가 -->
							<div class="card-body">
								<!-- eocraddimpl에서 가져온 값 저장용 -->
								<p id="start" th:text="${start}" hidden="hidden"></p>
								<p id="imgname" th:text="${imgname}" hidden="hidden"></p>

								<form id="add_form" action="#" class="text-start" method="post">
									<div class="input-group input-group-outline my-3">
										<label class="form-label">id</label>
										<input type="text" name="uid" class="form-control">
									</div>
									
									<div class="input-group input-group-outline mb-3">
										<label class="form-label">hospital</label>
										<input type="text" id="hospital" name="hospital" th:value="${hos}" class="form-control">
									</div>
										 
									<div class="input-group input-group-outline mb-3">
										<label class="form-label">pdate</label>
										<input id="pdate" type="date" name="pdate" th:value="${pdate}" class="form-control">
									</div>								
									
									<div class="input-group input-group-outline mb-3">
										<label class="form-label">days</label>
										<input id="days" name="days" type="text" th:value="${days}" class="form-control">
									</div>
                            		
									<div class="input-group input-group-outline mb-3">
										<label class="form-label">time</label>
										<input id="time" name="time" type="text" class="form-control">
									</div>
									
									<div class="input-group input-group-outline mb-3">
										<label class="form-label">dtime</label>
										<input id="dtime" name="dtime" type="text" class="form-control">
									</div>
									
									<!-- 약 input이 출력되는 div -->
									<div id="medidiv">
										<div class="input-group input-group-outline mb-3">
											<label class="form-label">medicine</label>
											<input id="name" name="name" type="text" class="form-control">
										</div>
									</div>

									<div class="text-center">
										<button id="add_btn" type="submit" class="btn bg-gradient-primary w-100 my-4 mb-2" >추가하기</button>
										<!-- OCR 버튼 - OCR Modal 창으로 이동 -->
										<button id="scan_bt" type="button" class="btn btn-block bg-gradient-primary mb-3" data-bs-toggle="modal" data-bs-target="#modal-default"><i class="fa fa-camera"></i></button>
										<a class="text-end" href="#" onclick="history.go(-1)" style='font-size: 0.8rem;'>취소</a>
									</div>
									
								</form>								
							</div>
						</div>
					</div>
				</div>
			</div>	
		</div>
	</main>
	<!-- End Main -->
	
	<!-- OCR Modal 창 -->
	<div class="modal fade" id="modal-default" tabindex="-1" role="dialog" aria-labelledby="modal-default" aria-hidden="true">
		<div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h6 class="modal-title" id="modal-title-default">이미지로 검색하기</h6>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<!-- 파일 업로드 -->
				<form id="ocrenv">
					<div id="modal-body" class="modal-body">
						<!-- input css 변경 -->
						<label for="file">
						  <a class="btn-upload">파일 선택</a>
						</label>
						<div class="form-group">
							<input type="file" id="file" name="mf" accept="image/*" onchange="readURL(this);">
						</div>
						<img id="preview">
						<h6>OR</h6>
						<!-- 이미지 링크 -->
						<input type="url" id="url-search" placeholder="이미지 링크"><!-- name 없애놓음 -->
					</div>
					<div class="modal-footer">
						<a id="envbt" class="btn bg-gradient-primary">검색</a>
						<button type="button" class="btn btn-link ml-auto" data-bs-dismiss="modal">닫기</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- OCR Modal 끝 -->

	
	<!--   Core JS Files   -->
	<script src="../assets/js/core/popper.min.js"></script>
	<script src="../assets/js/core/bootstrap.min.js"></script>
	<script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
	<script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
	<script>
		var win = navigator.platform.indexOf('Win') > -1;
		if (win && document.querySelector('#sidenav-scrollbar')) {
			var options = {
				damping: '0.5'
			}
			Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
		}
	</script>
	<!-- Github buttons -->
	<script async defer src="https://buttons.github.io/buttons.js"></script>
	<!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
	<script src="../assets/js/material-dashboard.min.js?v=3.0.4"></script>
</body>

</html>