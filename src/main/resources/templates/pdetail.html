<!DOCTYPE html>
<!--
=========================================================
* Material Dashboard 2 - v3.0.4
=========================================================

* Product Page: https://www.creative-tim.com/product/material-dashboard
* Copyright 2022 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->
<!-- Version: 4.0 -->
<!-- Description: 처방상세내역 및 복약관리 페이지

-------------------------------------------------------------------------
	Date			 Author							Note
-------------------------------------------------------------------------								    
2022. 7. 19.		noranbear			  처방상세내역 부분 화면 구성 완료
		
												  캘린더 추가	
												  
2022. 7. 22.		qwaszx357					footer 지우기

2022. 7. 25. 		najune						    기능구현

2022. 7. 30.		noranbear					알람 추가 창 구현

2022. 8. 2. 								화면 로드될 때, 해당 알람내역이
												캘린더에 뜨게 구현

-------------------------------------------------------------------------
-->

<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8">
<title>Insert title here</title>

<!-- 1. FullCalendar import 시작 -->
<link href='./fullcalendar/main.css' rel='stylesheet' />
<script src='./fullcalendar/main.js'></script>
<!-- 1. FullCalendar import 끝 -->


<style>
/* 처방약 이미지 크기 조절 */
.mpic {
	width: 182px;
	height: 98px;
	object-fit: contain;
}

/* 처방약 카드 호버 스타일 시작 */
.cpoint {
	transition: 0.2s ease;
}
.cpoint:hover {
	transform: scale(1.02);
}
/* 처방약 카드 호버 스타일 끝 */

#right{
text-align: right;
}

</style>

<script>

function caldisplay(data) {
	var calendarEl = document.getElementById('calendar');
	var sdate = null;
	var calendar = new FullCalendar.Calendar(calendarEl, {
		initialView: 'dayGridMonth',
		locale: 'ko',		// 한국어 버전
		// 날짜 selection 시작
		selectable: true,
		headerToolbar: {	// 선택된 날짜 확인용
			left: 'prev,next today',
			center: 'title',
			right: 'dayGridMonth'
		},
		fixedWeekCount: false,		// 보여주는 날짜 수
		dateClick: function(info) {
			//alert('clicked ' + info.dateStr);
			sdate = info.dateStr;	// 선택된 날짜를 담음
			
		},
		select: function(info) {
			//alert('selected ' + info.startStr + ' to ' + info.endStr);
		},
		// 날짜 selection 끝
		// schedule 가져오기 시작
		timeZone: 'local',
		headerToolbar: {
			center: 'addEventButton'
		},
		// add events 시작
		customButtons: {
			addEventButton: {
				text: '알람 추가',
		        click: function() {	
					//var dateStr = prompt('Enter a date in YYYY-MM-DD format');
					//var date = new Date(dateStr + 'T00:00:00'); // will be in local time

					$('#exampleModalSignUp').modal("show");		// modal 창 띄우기
					
					if (!isNaN(date.valueOf())) { // valid?
						calendar.addEvent({
							title: 'dynamic event',
							start: date,
							allDay: true
						});
						alert('Great. Now, update your database...');
					} else {
						alert('Invalid date.');
					}
				}
			}
		},
		// add events 끝
		editable: true,
		dayMaxEvents: true, // when too many events in a day, show the popover
		events: data,
		  color: 'yellow',   // an option!
		  textColor: 'black' // an option!,
		// schedule 가져오기 끝
		
	});
	
	calendar.render();
	
}


$(document).ready(function(){
	// 처방전 아이디
	var pid = $('#pid').text();

	// 알람 데이터 가져오기
	$.ajax({
		method: 'GET',
		url:'loadalarm',
		data:{'pid':pid},
		//dataType: 'json',
		success:function(data){
			caldisplay(data);
		},
		error: function(error) {
			alert("error");
		}
		
	});
	
	/* 알람추가 창에서 등록 버튼 클릭 시 */
	$('#reg_bt').click(function(){
		
		// 시간 DB에 등록
		$('#alarm-form').attr({
			'method':'get',
			'action':'alarmaddimpl'
		});
		
		$('#alarm-form').submit();
	
	});
});

</script>
    
    
<div class="row" th:each="p:${dp}">

	<!-- 1. 복약상세내역 시작 -->
	<div class="col-lg-6">
    	<div class="row">
    		<!-- 왼쪽: 처방내역 정보 -->
          	<div class="col-xl-8 mb-xl-0 mb-4" th:each="m:${medi}">
              <div class="card bg-transparent shadow-xl">
                <div class="overflow-hidden position-relative border-radius-xl">
                  <img src="../assets/img/illustrations/pattern-tree.svg" class="position-absolute opacity-2 start-0 top-0 w-100 z-index-1 h-100" alt="pattern-tree">
                  <span class="mask bg-gradient-dark opacity-10"></span>
                  <div class="card-body position-relative z-index-1 p-3">
                  	<!-- 처방내역 아이디 담아놓는 곳 -->
                  	<p id="pid" th:text="${p.id}" hidden="hidden"></p>
                    <h4 class="text-white mb-3 pb-2">
                    	<i class="fa fa-file-text-o text-white p-2" style="font-size:24px"></i>
                    	 처방내역 상세
                    </h4>
                    <h5 class="text-white mt-4 mb-5 pb-2" th:text="${p.pdate} + ' ~ ' + ${#dates.format(m.endday,'yyyy-MM-dd')}"></h5>
                    
                    <div class="d-flex" >
                      <div class="d-flex">
                        <div class="me-4">
                          <p class="text-white text-sm opacity-8 mb-0">복약일</p>
                          <h6 class="text-white mb-0" th:text="${p.days} + '일째'">(9일째/</h6>
               
                        </div>
                        <div>
                          <p class="text-white text-sm opacity-8 mb-0">약국</p>
                          <h6 class="text-white mb-0">전능의원</h6>
                        </div>
                      </div>
                      <div class="ms-auto w-20 d-flex align-items-end justify-content-end">
                        <img class="w-60 z-index-0 opacity-9" src="../img/qrcode.png" alt="QRcode">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
			<!-- 오른쪽: 순응도 -->
			<div class="col-xl-4">
				<div class="row">
					<div class="col-md-12 col-12">
						<div class="card">
							<div class="card-header mx-4 p-3 text-center">
								<div class="icon icon-shape icon-lg bg-gradient-primary shadow text-center border-radius-lg mt-sm-2">
									<i class="fas fa-poll opacity-10"></i>
								</div>
							</div>
							<div class="card-body pt-0 p-3 py-4 text-center">
								<h6 class="text-center mb-0">복약 순응도</h6>
								<hr class="horizontal dark my-3">
								<h2 class="mb-0">60%</h2>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 중간: 병원 정보 -->
			<div class="col-md-12 mb-lg-0 mb-2" >
				<div class="card mt-4">
					<div class="card-header pb-0 p-3">
						<div class="row">
							<div class="col-6 d-flex align-items-center">
								<h6 class="mb-0">병원 정보</h6>
							</div>
							<div class="col-6 text-end">
								<a class="btn bg-gradient-dark mb-0" href="javascript:;"><i class="fas fa-map-marker-alt text-sm"></i>&nbsp;&nbsp;지도로 보기</a>
							</div>
						</div>
					</div>
					<div class="card-body p-3">
						<div class="row">
							<div class="col-md-6 mb-md-0 mb-4">
								<div class="card card-body border card-plain border-radius-lg d-flex align-items-center flex-row">
                        			<i class='fas fa-hospital me-sm-3 text-dark' style='font-size:24px'></i>
                        			<h6 class="ms-3 mb-0" th:text="${p.hospital}">어쩌구 병원</h6>
                        			<i class="fa fa-copy ms-auto text-dark cursor-pointer" style="font-size:18px" data-bs-toggle="tooltip" data-bs-placement="top" title="복사"></i>
                      			</div>
							</div>
							<div class="col-md-6">
								<div class="card card-body border card-plain border-radius-lg d-flex align-items-center flex-row">
									<i class='fas fa-mobile-alt text-dark me-sm-3' style='font-size:24px'></i>
                        			<h6 class="ms-3 mb-0">02-1234-5678</h6>
                        			<i class="fa fa-copy ms-auto text-dark cursor-pointer" style="font-size:18px" 
                        			data-bs-toggle="tooltip" data-bs-placement="top" title="복사"></i>					
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 밑: 처방약 시작 -->
			<div class="col-md-12 mt-4 mb-xl-0 mb-4" th:each="m:${medi}"> 
				<div class="card">
					<div class="card-header pb-0 px-3">
						<h6 class="mb-0">처방약</h6>
					</div>
					<div class="card-body pt-4 p-3">
						<ul class="list-group">
							<li class="cpoint list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
								<div class="d-flex flex-column" th:each="p:${dp}">
									<h6 class="mb-3 text-sm" th:text="${m.name}">약이름 1</h6>						
									<span class="mb-2 text-xs">복약횟수: <span class="text-dark ms-sm-2 font-weight-bold" th:text="'1일 ' + ${p.time} + '회'"></span></span>
									<span class="mb-2 text-xs">복약시간: <span class="text-dark ms-sm-2 font-weight-bold" th:text="${p.dtime}"></span></span>
									<span class="text-xs">복약일수: <span class="text-dark ms-sm-2 font-weight-bold" th:text="${p.days}  + '일'"></span></span>
								</div>
								<div class="ms-auto text-end">
									<img class="mpic" src="../img/main-logo.png">
								</div>
							</li>
			
						</ul>
					</div>
				</div>
			</div>
			<!-- 밑: 처방약 끝 -->
			
		</div>
	</div>
	<!-- 1. 복약상세내역 끝 -->
	
	
	<!-- 2. 복약알림 시작 -->
	<!-- 위: 복약캘린더 -->
	<div class="col-lg-6">
		<div class="col-md-12 mb-lg-0 mb-2">
			<div class="card h-100">
				<div class="card-header pb-0 p-3">
					<div class="row">
						<div class="col-6 d-flex align-items-center">
							<h6 class="mb-0">복약 캘린더</h6>
						</div>
						<div class="col-6 text-end">
							<!-- 복약 중지 버튼 Modal 시작 -->
							<button type="button" class="btn btn-outline-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#modal-default">복약중지</button>
							<!-- Modal 창 -->
							<div class="modal fade" id="modal-default" tabindex="-1" role="dialog" aria-labelledby="modal-default" aria-hidden="true">
								<div class="modal-dialog modal-danger modal-dialog-centered modal-" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h6 class="modal-title" id="modal-title-notification">복약 중지 확인</h6>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">×</span>
											</button>
										</div>
										<div class="modal-body">
											<div class="py-3 text-center">
												<i class="fas fa-exclamation-triangle ni-3x"></i>
												<h5 class="text-primary mt-4">이 처방내역의 복약을 중지하시겠습니까?</h5>
												<p>복약기간을 완료하지 않고<br> 복약을 중지하면 순응도를 잃게 됩니다.</p>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn bg-gradient-primary">확인</button>
											<button type="button" class="btn btn-link ml-auto" data-bs-dismiss="modal">닫기</button>
										</div>
									</div>
								</div>
						    </div>
							<!-- 복약중지 버튼 Modal 끝 -->
						</div>
					</div>
				</div>
				<div class="card-body p-3 pb-0">
					<!-- FullCalendar div -->
					<div id='calendar' class="mb-sm-3"></div>
				</div>
				
				<!-- 알람설정 Modal 시작 -->
			    <div class="modal fade" id="exampleModalSignUp" tabindex="-1" role="dialog" aria-labelledby="exampleModalSignTitle" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-sm" role="document">
						<div class="modal-content">
							<div class="modal-body p-0">
								<div class="card card-plain">
									<div class="card-header pb-0 text-left">
										<h3 class="font-weight-bolder text-primary text-gradient">
											<i class="material-icons text-bold text-primary text-5xl">alarm</i>
											알람 추가
										</h3>
										<p class="mb-0">해당 처방전의 복용 알람을 추가해 보세요.</p>
			             			</div>
			              			<div class="card-body pb-3">
			              				<form role="form text-left" id="alarm-form">
			              				  	<label>아침</label>
											<div class="input-group mb-3">
												<input type="time" class="form-control" name="morning">
											</div>
											<label>점심</label>
											<div class="input-group mb-3">
												<input type="time" class="form-control" name="afternoon">
											</div>
											<label>저녁</label>
											<div class="input-group mb-3">
												<input type="time" class="form-control" name="dinner">
											</div>
											<div class="text-center">
												<button type="button" id="reg_bt" th:onclick="|location.href='@{/alarmaddimpl(id=${p.id})}'|"
													class="btn bg-gradient-primary btn-lg btn-rounded w-100 mt-4 mb-0">
													등록
												</button>
											</div>
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			    <!-- 알람설정 Modal 끝 -->
			    
			</div>
		</div>
	
		<!-- 밑: 복약내역 알람리스트 시작 -->
		<div class="col-md-12 mt-4">
			<div class="card h-100 mb-4">
				<div class="card-header pb-0 px-3">
					<div class="row">
						<div class="col-md-6">
							<h6 class="mb-0">복약알람</h6>
						</div>
						<div class="col-md-6 d-flex justify-content-start justify-content-md-end align-items-center">
							<i class="material-icons me-2 text-lg">date_range</i>
							<small>23 - 30 March 2020</small>
						</div>
					</div>
				</div>
				<div class="card-body pt-4 p-3">
					<h6 class="text-uppercase text-body text-xs font-weight-bolder mb-3">Newest</h6>
					<ul class="list-group">
						<li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
							<div class="d-flex align-items-center">
								<button class="btn btn-icon-only btn-rounded btn-outline-danger mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-icons text-lg">expand_more</i></button>
								<div class="d-flex flex-column">
									<h6 class="mb-1 text-dark text-sm">Netflix</h6>
									<span class="text-xs">27 March 2020, at 12:30 PM</span>
								</div>
							</div>
							<div class="d-flex align-items-center text-danger text-gradient text-sm font-weight-bold">
								- $ 2,500
							</div>
						</li>
						<li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
							<div class="d-flex align-items-center">
								<button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-icons text-lg">expand_less</i></button>
								<div class="d-flex flex-column">
									<h6 class="mb-1 text-dark text-sm">Apple</h6>
									<span class="text-xs">27 March 2020, at 04:30 AM</span>
								</div>
							</div>
							<div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
								+ $ 2,000
							</div>
						</li>
					</ul>
					<h6 class="text-uppercase text-body text-xs font-weight-bolder my-3">Yesterday</h6>
					<ul class="list-group">
						<li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
							<div class="d-flex align-items-center">
								<button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-icons text-lg">expand_less</i></button>
								<div class="d-flex flex-column">
									<h6 class="mb-1 text-dark text-sm">Stripe</h6>
									<span class="text-xs">26 March 2020, at 13:45 PM</span>
								</div>
							</div>
							<div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
								+ $ 750
							</div>
						</li>
						<li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
							<div class="d-flex align-items-center">
								<button class="btn btn-icon-only btn-rounded btn-outline-dark mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-icons text-lg">priority_high</i></button>
								<div class="d-flex flex-column">
									<h6 class="mb-1 text-dark text-sm">Webflow</h6>
									<span class="text-xs">26 March 2020, at 05:00 AM</span>
								</div>
							</div>
							<div class="d-flex align-items-center text-dark text-sm font-weight-bold">
								Pending
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!-- 밑: 복약내역 알람리스트 끝 -->
	</div>
	<!-- 2. 복약알림 끝 -->
	
</div>